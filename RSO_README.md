# Runtime Safety Observer (RSO) v1.0

## Описание

Runtime Safety Observer (RSO) v1.0 — внешний read-only наблюдатель для торговой системы. RSO предназначен для пассивного мониторинга состояния системы без вмешательства в её работу.

## Абсолютные правила

RSO следует строгим правилам, которые **не подлежат обсуждению**:

1. **READ-ONLY OBSERVER**: Только чтение данных, никаких записей, контроля или административных действий
2. **NO CONTROL LOGIC**: Не модифицирует торговую логику, FSM, risk core, config или lifecycle
3. **NO ADMIN ACTIONS**: Не инициирует учения, перезапуски, паузы, возобновления или симуляцию рынка
4. **NO VERDICT COMPUTATION**: Не вычисляет PASS/FAIL или любые вердикты
5. **EXTERNAL PROCESS**: Работает как внешний процесс, не встраивается в торговый runtime

## Разрешенные действия

RSO может выполнять только следующие действия:

- ✅ Читать статусные эндпоинты
- ✅ Читать структурированные логи
- ✅ Отслеживать переходы FSM
- ✅ Записывать временные метки и события
- ✅ Сериализовать данные в JSON/MD строго по предоставленной схеме

## Установка

RSO не требует установки зависимостей, кроме стандартной библиотеки Python 3.8+.

```bash
# Убедитесь, что вы в директории проекта
cd /path/to/market_bot

# RSO готов к использованию
python rso.py --help
```

## Использование

### Базовое использование

```bash
# Запуск RSO (создаст JSON и Markdown отчеты)
python rso.py
```

### Опции командной строки

```bash
# Указать корневую директорию проекта
python rso.py --project-root /path/to/market_bot

# Указать директорию для вывода отчетов
python rso.py --output-dir /path/to/reports

# Вывести только JSON отчет
python rso.py --json-only

# Вывести только Markdown отчет
python rso.py --md-only
```

### Примеры использования

```bash
# Стандартный запуск
python rso.py

# Запуск с указанием директорий
python rso.py --project-root /root/market_bot --output-dir /tmp/rso_reports

# Только JSON отчет
python rso.py --json-only --output-dir /tmp/rso_reports
```

## Формат вывода

### JSON отчет

RSO создает JSON отчет со следующей структурой:

```json
{
  "rso_version": "1.0",
  "timestamp": "2024-01-01T12:00:00+00:00",
  "observation_type": "read_only",
  "fsm_state": {
    "current_state": "RUNNING",
    "duration_in_state": 3600.0,
    "consecutive_errors": 0,
    "recovery_cycles": 0,
    "safe_mode_entered_at": null,
    "last_heartbeat": "2024-01-01T12:00:00+00:00",
    "transitions_count": 5,
    "last_transition": {
      "from": "DEGRADED",
      "to": "RUNNING",
      "reason": "errors reset",
      "incident_id": "state-abc123",
      "timestamp": "2024-01-01T11:00:00+00:00"
    },
    "all_transitions": [...]
  },
  "system_state": {
    "timestamp": "2024-01-01T12:00:00+00:00",
    "system_health": {...},
    "performance_metrics": {...},
    "trading_decision": {...},
    ...
  },
  "recent_logs": [...],
  "fsm_transitions": [...],
  "metadata": {
    "observer_mode": "external",
    "read_only": true,
    "no_verdict": true
  }
}
```

### Markdown отчет

RSO создает Markdown отчет с секциями:

- **FSM State**: Текущее состояние конечного автомата
- **System State**: Состояние системы (health, performance, trading decision)
- **FSM Transitions**: История переходов состояний
- **Recent Logs**: Последние записи логов

## Что читает RSO

RSO читает следующие данные (только чтение):

1. **FSM State** (`system_state_machine.py`):
   - Текущее состояние (RUNNING, DEGRADED, SAFE_MODE, RECOVERING, FATAL)
   - Длительность в текущем состоянии
   - Количество последовательных ошибок
   - Циклы восстановления
   - История переходов состояний

2. **System State** (`system_state.py`):
   - Состояние здоровья системы
   - Метрики производительности
   - Решение о торговле
   - Состояние рынка, риска, когнитивное состояние

3. **Structured Logs** (`runner.log`):
   - Последние записи логов
   - Уровни логирования (CRITICAL, ERROR, WARNING, INFO, DEBUG)

4. **FSM Transitions**:
   - История переходов состояний
   - Причины переходов
   - Incident IDs для корреляции

## Ограничения

- RSO не может читать данные, если торговый бот не запущен (модули не инициализированы)
- RSO не может читать данные, если файлы логов недоступны
- RSO записывает `null` для недоступных данных (не интерпретирует)

## Автоматизация

RSO можно запускать периодически через cron:

```bash
# Добавить в crontab (каждые 5 минут)
*/5 * * * * cd /root/market_bot && python rso.py --output-dir /var/log/rso_reports >> /var/log/rso.log 2>&1
```

## Безопасность

RSO полностью безопасен для использования в production:

- ✅ Только чтение данных
- ✅ Не модифицирует систему
- ✅ Не влияет на производительность торговой системы
- ✅ Не требует специальных прав доступа

## Troubleshooting

### RSO не может прочитать FSM state

**Причина**: Торговый бот не запущен или модули не инициализированы.

**Решение**: Убедитесь, что торговый бот запущен (`systemctl status market-bot`).

### RSO не может прочитать логи

**Причина**: Файл `runner.log` не существует или недоступен.

**Решение**: Проверьте наличие файла и права доступа.

### RSO выводит null для всех данных

**Причина**: Торговый бот не запущен или RSO запущен из неправильной директории.

**Решение**: 
1. Убедитесь, что торговый бот запущен
2. Запустите RSO с `--project-root /path/to/market_bot`

## Архитектурные требования

RSO соответствует следующим архитектурным требованиям:

- ✅ **Architecture v1.0 FROZEN**: Не изменяет архитектуру
- ✅ **Fail-closed semantics**: Не влияет на работу системы
- ✅ **External process**: Работает как внешний процесс
- ✅ **Read-only**: Только чтение данных

## Если требуется изменение функциональности

Если запрошенная функциональность нарушает правила проекта, RSO остановится и сообщит, что требуется **ADR (Architecture Decision Record)** для изменения архитектуры.

## Версия

**RSO v1.0** — соответствует архитектуре торговой системы v1.0 (FROZEN).

---

**Примечание**: RSO является инструментом мониторинга и не заменяет систему логирования или мониторинга торговой системы. Используйте RSO для дополнительного наблюдения за состоянием системы.

