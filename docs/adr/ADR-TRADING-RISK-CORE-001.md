# ADR-TRADING-RISK-CORE-001: Trading Risk Core v1.0

**Статус:** ACCEPTED  
**Дата:** 2024-12-19  
**Автор(ы):** System Architect  
**Участники обсуждения:** Architecture Team

---

## Контекст

Требуется реализовать независимый модуль Trading Risk Core v1.0 как чистый слой принудительного применения политик риска.

**Проблема:**
- Текущая система риска распределена между несколькими модулями
- Отсутствует единая точка контроля риска с правом вето
- Нет детерминированного конечного автомата состояний риска
- Риск-логика смешана со стратегической логикой

**Требования:**
- Risk Core должен быть изолированным модулем
- Детерминированный FSM с состояниями: SAFE, LIMITED, LOCKED, HALTED
- Реализация всех инвариантов риска
- Право вето на торговлю
- Fail-closed семантика везде

---

## Решение

### 1. Risk Core как независимый модуль

**Расположение:** `core/risk_core.py`

**Характеристики:**
- Изолированный модуль
- Детерминированный
- Без состояния (кроме FSM состояния, счетчиков, таймеров)
- Чистый слой принудительного применения политик

### 2. Канонические состояния риска (FSM)

```
SAFE → LIMITED → LOCKED → HALTED
  ↑       ↑         ↑
  └───────┴─────────┘ (recovery paths)
```

**Состояния:**
- **SAFE**: Полное разрешение на торговлю
- **LIMITED**: Ограниченная торговля (размер позиций ограничен)
- **LOCKED**: Торговля заблокирована (исключительное восстановление)
- **HALTED**: Торговля остановлена (терминальное состояние, нет автоматического восстановления)

**Правила переходов:**
- Порядок серьезности: HALTED > LOCKED > LIMITED > SAFE
- Неизвестное > Известное
- Капитал > Поведение
- Множественные нарушения → выбирается высшая серьезность
- Нет автоматического восстановления из HALTED
- Восстановление из LOCKED исключительное

### 3. Инварианты (обязательная реализация)

#### 3.1 Капитал
- **Абсолютный лимит потерь**: Максимальная потеря капитала не может быть превышена
- **Временной лимит потерь**: Потери за период времени не могут превышать лимит
- **Необратимость**: Потери капитала необратимы (только нарастание)

#### 3.2 Экспозиция
- **Лимит одной позиции**: Максимальный размер одной позиции
- **Агрегированный лимит экспозиции**: Суммарная экспозиция не может превышать лимит
- **Лимит коррелированной группы**: Группа коррелированных позиций не может превышать лимит (стратегия-слепой)

#### 3.3 Поведенческие
- **Ограничение частоты действий**: Максимальное количество действий за период
- **Подавление повторных потерь**: После потери запрет на повторные попытки
- **Принуждение периода ожидания**: Принудительный период ожидания после определенных событий

#### 3.4 Системные / Неизвестные
- **Небезопасный runtime → LOCKED**: Если runtime небезопасен, переход в LOCKED
- **Неизвестное состояние → HALTED**: Если состояние неопределено, переход в HALTED

#### 3.5 Мета
- **Попытка обхода → HALTED**: Любая попытка обхода Risk Core приводит к HALTED

### 4. Интерфейсы (строгий контракт)

#### Входы (только факты):
- **Trading Intent**: Факты о намерении торговли (символ, направление, размер, стоп)
- **Capital & Exposure Snapshot**: Текущий капитал и экспозиция
- **Behavioral Counters**: Счетчики поведения (количество действий, потери)
- **System Health Flags**: Флаги здоровья системы (только чтение)

#### Выходы (только разрешения):
- **Trading Permission**: 
  - `ALLOW` - полное разрешение
  - `ALLOW_LIMITED` - ограниченное разрешение (размер ограничен)
  - `DENY` - запрет торговли
- **Risk State**: Текущее состояние риска (для наблюдаемости)
- **Violation Report**: Отчет о нарушениях (внутренний)

### 5. Запрещенное знание

Risk Core **НЕ ДОЛЖЕН** знать:
- Логику стратегии
- Индикаторы
- Уровни уверенности
- Ожидаемую прибыль
- Причины сигналов
- Режим рынка

### 6. Семантика отказов

- Если Risk Core падает → DENY
- Если входы неконсистентны → HALTED
- Если состояние неопределено → HALTED
- Если инвариант неясен → DENY

---

## Альтернативы

### Альтернатива 1: Интеграция в Decision Core
**Описание:** Добавить Risk Core логику в Decision Core  
**Плюсы:** Меньше модулей  
**Минусы:** Нарушение разделения ответственности, смешивание стратегии и риска  
**Почему отклонена:** Нарушает принцип изоляции и fail-safe архитектуру

### Альтернатива 2: Мягкие переопределения
**Описание:** Добавить возможность обхода Risk Core в особых случаях  
**Плюсы:** Гибкость  
**Минусы:** Нарушает fail-safe принцип, создает уязвимости  
**Почему отклонена:** Нарушает принцип "всегда fail-closed"

---

## Последствия

### Положительные последствия
- Единая точка контроля риска
- Детерминированное поведение
- Четкое разделение ответственности
- Fail-safe гарантии
- Наблюдаемость состояний риска

### Отрицательные последствия
- Дополнительный слой проверок (минимальный overhead)
- Требуется интеграция в существующий flow

### Риски
- **Риск:** Неправильная интеграция может обойти Risk Core  
**Митигация:** Строгий контракт интерфейсов, архитектурные проверки
- **Риск:** Неправильная реализация инвариантов  
**Митигация:** Детальное тестирование, верификация против ADR

---

## Затронутые инварианты

**Инварианты:**
- [x] INV-1: CRITICAL MODULE AVAILABILITY
- [x] INV-2: DECISION CORE AUTHORITY
- [x] INV-3: SYSTEM STATE CONSISTENCY
- [x] INV-4: GUARDIAN-FIRST ENFORCEMENT
- [x] INV-5: NO FAIL-OPEN FOR CRITICAL

**Анализ влияния:**
- **INV-1**: Risk Core является критическим модулем, должен быть всегда доступен
- **INV-2**: Risk Core имеет право вето, но не заменяет Decision Core
- **INV-3**: Risk Core управляет состоянием риска через FSM
- **INV-4**: Risk Core проверяется после SystemGuardian, но перед торговлей
- **INV-5**: Risk Core всегда fail-closed, никогда не fail-open

---

## Затронутые компоненты

**Критические модули:**
- [x] DecisionCore (интеграция Risk Core проверки)
- [ ] SystemGuardian (не изменяется)
- [ ] SystemStateMachine (не изменяется)
- [x] Gatekeeper (интеграция Risk Core проверки)
- [ ] RiskExposureBrain (может использоваться Risk Core для данных)

**Некритические модули:**
- Нет

**Документация:**
- Создание `core/risk_core.py`
- Обновление архитектурной документации

---

## План реализации

1. Создать ADR-TRADING-RISK-CORE-001
2. Реализовать `core/risk_core.py` с FSM
3. Реализовать все инварианты (Capital, Exposure, Behavioral, Systemic, Meta)
4. Интегрировать в Gatekeeper/Decision Core flow
5. Добавить тесты и верификацию
6. Обновить документацию

---

## Верификация

**Проверки:**
- [x] Инварианты не нарушены
- [x] Fail-safe поведение сохранено
- [ ] Тесты обновлены (после реализации)
- [ ] Документация обновлена (после реализации)
- [ ] Каноническая архитектура обновлена (если требуется)

**Критерии успеха:**
- Risk Core нельзя обойти
- Стратегия не может обнаружить лимиты риска
- Исполнение не может действовать без разрешения
- Все инварианты отображаются на переходы FSM
- Все переходы детерминированы
- HALTED терминален
- Fail-closed везде

---

## Связанные документы

- `SYSTEM_ARCHITECTURE_CANONICAL.md`
- `FAIL_SAFE_ARCHITECTURE.md`
- `core/decision_core.py`
- `execution/gatekeeper.py`

---

## История изменений

| Дата | Автор | Изменение |
|------|-------|-----------|
| 2024-12-19 | System Architect | Создан ADR |
| 2024-12-19 | System Architect | Обновлён статус на ACCEPTED |

---

## Примечания по реализации

### Ключевые принципы (НЕ НАРУШАТЬ)

1. **Risk Core НЕ стратегия** - не оптимизирует PnL
2. **Risk Core НЕ исполнение** - не выполняет сделки
3. **Risk Core НЕ объясняет** - не объясняет стратегии почему запрещено
4. **Risk Core всегда fail-closed** - при неопределенности запрещает
5. **Risk Core имеет право вето** - может запретить любую торговлю

### Строгие правила

- НЕ модифицировать существующую runtime архитектуру
- НЕ добавлять стратегическую логику
- НЕ добавлять логику исполнения
- НЕ оптимизировать PnL
- НЕ добавлять эвристики или "умное" поведение
- НЕ вводить новые состояния риска
- НЕ вводить мягкие переопределения, debug bypasses, feature flags
- НЕ изменять семантику инвариантов
- НЕ объединять Risk Core с другими слоями

### Разрешенное

- Реализация Risk Core как чистый слой принудительного применения политик
- Реализация инвариантов точно как указано
- Реализация FSM точно как указано
- Добавление наблюдаемости и логирования
- Добавление валидации и проверок консистентности
- Fail-closed при любой неопределенности

