# Runtime / System / Invariant Tests

–ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä runtime/system/invariant —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã `market_bot`.

## üéØ –¶–µ–ª—å

–≠—Ç–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
- **–ò–ù–í–ê–†–ò–ê–ù–¢–´** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- **–ò–ó–û–õ–Ø–¶–ò–Æ** offline-–º–æ–¥—É–ª–µ–π
- **–ö–û–†–†–ï–ö–¢–ù–û–°–¢–¨** —è–¥–µ—Ä —Ä–µ—à–µ–Ω–∏–π
- **–°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨** runtime
- **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨** –¥–ª—è production

## ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–í–ê–ñ–ù–û:** –í—Å–µ —Ç–µ—Å—Ç—ã **–ë–ï–ó–û–ü–ê–°–ù–´** –¥–ª—è production:
- ‚ùå –ù–ï —Ç–æ—Ä–≥—É—é—Ç
- ‚ùå –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–∏–≥–Ω–∞–ª—ã –≤ Telegram
- ‚ùå –ù–ï –∏–∑–º–µ–Ω—è—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏

## üöÄ –ó–∞–ø—É—Å–∫

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ (Linux/Mac)

```bash
bash runtime_tests.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ (Windows PowerShell)

```powershell
.\runtime_tests.ps1
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ó–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

–ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ, —Å–∫–æ–ø–∏—Ä–æ–≤–∞–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫ –∏–∑ `runtime_tests.sh` –∏–ª–∏ `runtime_tests.ps1`:

**Linux/Mac:**
```bash
python3 - <<EOF
# –ö–æ–¥ —Ç–µ—Å—Ç–∞ –∑–¥–µ—Å—å
EOF
```

**Windows PowerShell:**
```powershell
python - <<'PYTHON_EOF'
# –ö–æ–¥ —Ç–µ—Å—Ç–∞ –∑–¥–µ—Å—å
PYTHON_EOF
```

## üìã –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤

### 1Ô∏è‚É£ MarketState / Enum Invariants
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ `SignalSnapshot` –∏–∑ –ë–î
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ `states` ‚Äî dict
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ `MarketState` enum –∏–ª–∏ `None`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä–æ–∫, int, float –≤ runtime

### 2Ô∏è‚É£ SignalSnapshot Integrity
- –°–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—ã–π `SignalSnapshot`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `frozen=True` (immutable)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–µ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ `states` –Ω–µ –º—É—Ç–∏—Ä—É—é—Ç—Å—è

### 3Ô∏è‚É£ Gatekeeper Decision Flow
- –°–æ–∑–¥–∞—ë—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π `SignalSnapshot`
- –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —á–µ—Ä–µ–∑ `Gatekeeper`
- –£–±–µ–∂–¥–∞–µ—Ç—Å—è, —á—Ç–æ:
  - `MetaDecisionBrain` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - `PortfolioBrain` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - `PositionSizer` ‚Üí –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç runtime —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π

### 4Ô∏è‚É£ MetaDecisionBrain (WHEN NOT TO TRADE)
- –í—ã—Å–æ–∫–∞—è entropy ‚Üí BLOCK
- –ù–∏–∑–∫–∞—è confidence ‚Üí BLOCK
- `SystemHealth != OK` ‚Üí BLOCK
- –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è ‚Üí ALLOW

### 5Ô∏è‚É£ PositionSizer Safety
- –ü–µ—Ä–µ–¥–∞—ë—Ç extreme –∑–Ω–∞—á–µ–Ω–∏—è:
  - `confidence > 1`
  - `entropy < 0`
  - `portfolio_exposure > 1`
- –£–±–µ–∂–¥–∞–µ—Ç—Å—è:
  - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ –≤ `[0, 1]`
  - `position_allowed == False` –ø—Ä–∏ —Ä–∏—Å–∫–µ
  - NaN / inf –Ω–µ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è

### 6Ô∏è‚É£ PortfolioBrain Exposure Rules
- –ü–µ—Ä–µ–¥–∞—ë—Ç –ø–æ—Ä—Ç—Ñ–µ–ª—å:
  - –ø—Ä–µ–≤—ã—à–∞—é—â–∏–π `risk_budget`
  - —Å –≤—ã—Å–æ–∫–æ–π –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–µ–π
- –£–±–µ–∂–¥–∞–µ—Ç—Å—è, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `BLOCK`
- –ü—Ä–∏ –ø—É—Å—Ç–æ–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ ‚Üí `ALLOW`

### 7Ô∏è‚É£ ReplayEngine Isolation Test
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ snapshots
- –ü—Ä–æ–≥–æ–Ω—è–µ—Ç —á–µ—Ä–µ–∑ `ReplayEngine`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
  - snapshot'—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
  - –ë–î –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
  - –Ω–µ—Ç –≤—ã–∑–æ–≤–æ–≤ runtime –ª–æ–≥–∏–∫–∏
- –¢–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π summary

### 8Ô∏è‚É£ DriftDetector Safety Test
- –ü–µ—Ä–µ–¥–∞—ë—Ç snapshots
- –ü–æ–ª—É—á–∞–µ—Ç `drift_report`
- –£–±–µ–∂–¥–∞–µ—Ç—Å—è:
  - –Ω–µ—Ç side effects
  - –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π snapshot
  - –∑–Ω–∞—á–µ–Ω–∏—è entropy/confidence –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### 9Ô∏è‚É£ Runtime Loop Safety (Dry Mode)
- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç runner
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –û–î–ò–ù –∞–Ω–∞–ª–∏–∑ —Å–∏–º–≤–æ–ª–∞
- –£–±–µ–∂–¥–∞–µ—Ç—Å—è:
  - Telegram –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
  - –°–¥–µ–ª–∫–∏ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
  - –ò—Å–∫–ª—é—á–µ–Ω–∏–π –Ω–µ—Ç

### üîü Full Ecosystem Smoke Test
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç:
  - load snapshots
  - ReplayEngine
  - DriftDetector
  - PortfolioBrain
  - MetaDecisionBrain
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
  - —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç
  - –≤—Å–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ–±–ª—é–¥–µ–Ω—ã
  - –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è < 5 —Å–µ–∫

## üîß –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.8+
- –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ `requirements.txt`
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite (—Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

## üìù –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞

–ö–∞–∂–¥—ã–π —Ç–µ—Å—Ç –≤—ã–≤–æ–¥–∏—Ç:
- `‚úÖ ... OK` –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
- `‚ö†Ô∏è  ...` –ø—Ä–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–∏ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- `‚ùå ...` –ø—Ä–∏ –æ—à–∏–±–∫–µ (—Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç)

## üêõ –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ —Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –í—Å–µ —Ç–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
- –¢–µ—Å—Ç—ã –≤—ã—è–≤–ª—è—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- –¢–µ—Å—Ç—ã –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

